# Nouveau драйвер:

## Смена проприетарного драйвера от NVIDIA на Nouveau

- Перейдите в режим root:

```shell
su -
```

- Удалите `nvidia_glx_common`:

::: code-group

```shell[apt-get]
apt-get remove nvidia_glx_common
```

```shell[epm]
epm -e nvidia_glx_common
```

:::

- Удалите `initcall_blacklist` и `nvidia-drm.modeset`, если они есть:

```shell
mcedit /etc/sysconfig/grub2
```

- Сгенерируйте `grub.cfg`

```shell
grub-mkconfig -o /boot/grub/grub.cfg
```

- Удалите правила, запрещающие Nouveau, если они есть:

```shell
rm /etc/modprobe.d/blacklist-nvidia-x11.conf
```

- Удалите изменение размещения видеопамяти, если оно есть:

```shell
rm /etc/modprobe.d/nvidia_videomemory_allocation.conf
```

- Установите драйвер (пример для ядра `un-def`):

::: code-group

```shell[apt-get]
apt-get install kernel-modules-drm-nouveau-un-def
```

```shell[epm]
epm -i kernel-modules-drm-nouveau-un-def
```

:::

- Если у Вас видеокарта **Curie** или старше, удостоверьтесь, что у вас установлен пакет с Xf86-video-nouveau:

::: code-group

```shell[apt-get]
apt-get install xorg-drv-nouveau
```

```shell[epm]
epm -i xorg-drv-nouveau
```

:::

- Перезагрузите систему

```shell
su -
reboot
```

Как только система загрузилась можно убедиться в том, что Nouveau заработало (в выводе сборки `initrd` должен присутствовать Nouveau):

```shell
su -
make-initrd
reboot
```

::: danger
Для видеокарт Kepler и Maxwell потребуется обязательное [внедрение прошивки NVIDIA](#внедрение-прошивки-nvidia).
:::

## Управление питанием (Turing и новее)

Nouveau — драйвер с открытым исходным кодом для графических процессоров NVIDIA, развивается посредством реверс-инжиниринга. До архитектуры Turing, в управлении питанием возникали проблемы, о чём можно посмотреть на странице [Power Management](https://nouveau.freedesktop.org/PowerManagement.html).

Начиная с архитектуры Turing, видеокарты получили полную поддержку управления питанием благодаря GSP-прошивкам от NVIDIA. Видеокарты на базе архитектур Ampere и Ada Lovelace имеют эту поддержку по умолчанию. Для видеокарт на базе архитектуры Turing **необходимо указать специальный параметр ядра**.

Для того, чтобы на видеокартах Turing заработало управление питанием, необходимо прописать в параметр `GRUB_CMDLINE_LINUX_DEFAULT` значение `nouveau.config=NvGspRm=1` и сгенерировать новый `grub.cfg`:

```shell
su -
mcedit /etc/sysconfig/grub2
grub-mkconfig -o /boot/grub/grub.cfg
```
## Внедрение прошивки NVIDIA

Большинство видеочипов NVIDIA имеют встроенный аппаратный декодер, и некоторые видеочипы для его работы отдельно требуют извлечённую из драйвера прошивку NVIDIA. Прошивка NVIDIA требуется для видеокарт с аппаратным декодером: VP1, VP2, VP3, VP4.0, VP4.2, VP5 или VP6+. Список видеокарт с данными декодерами можно посмотреть на странице [Video Acceleration](https://nouveau.freedesktop.org/VideoAcceleration.html) в блоке `Which card has what engine`

::: info
Хоть вышеупомянутые аппаратные декодеры и требуют прошивку NVIDIA, не во всех реализована её поддержка. Статус поддержки для конкретного декодера смотрите на сайте [Video Acceleration](https://nouveau.freedesktop.org/VideoAcceleration.html) в блоке `Video engine support status`
:::

::: danger
Видеочипы Kepler и Maxwell для их нормальной загрузки обязательно требуют внедрение прошивки. Если при первой установке или запуске системы на устройствах с видеочипом одной из этих архитектур наблюдаются проблемы, можно временно перейти на [другой видеорежим](/graphics/nvidia/nvidia-drivers/#черныи-экран-при-выборе-сессии-x11-или-ошибка-в-инициализации-cuda)
:::

- Установка прошивки:

::: code-group

```shell[apt-get]
apt-get install firmware-nouveau
```

```shell[epm]
epm -i firmware-nouveau
```

::: details Ручная установка прошивки

- Распакуйте прошивку:

```shell
mkdir -p /tmp/nouveau && cd /tmp/nouveau
wget http://us.download.nvidia.com/XFree86/Linux-x86_64/340.108/NVIDIA-Linux-x86_64-340.108.run
wget https://raw.github.com/envytools/firmware/master/extract_firmware.py
sh NVIDIA-Linux-x86_64-340.108.run --extract-only
python3 extract_firmware.py
```

- Установите прошивку:

```shell
su -
cd /tmp/nouveau
mkdir /lib/firmware/nouveau
cp -d nv* vuc-* /lib/firmware/nouveau/
```

:::

### Reclocking (от Celsius до Fermi)

Видеочипы до архитектуры Turing не имеют поддержку управления питания на Nouveau, из-за чего остаются в режиме пониженного энергопотребления и пониженными частотами. Но на некоторых архитектурах есть возможность менять частоты GPU и видеопамяти через уже заготовленные пресеты состояния питания. Видеочипы от Celsius до Tesla имеют возможность изменять частоты видеопамяти, а видеокарты от Rankine до Fermi имеют возможность изменять частоты GPU. Все, кто входят и в 1-ый и 2-ой диапазоны имеют управление частот и GPU, и видеопамяти, что будет отображено в описании пресетов.

- Проверьте доступные состояния питания:

```shell
su -
cat /sys/kernel/debug/dri/0/pstate
```

::: details Ожидаемый вид вывода

```shell
07: core 405 MHz memory 810 MHz
0f: core 653-954 MHz memory 1600 MHz
AC: core 953 MHz memory 1600 MHz
```

:::

- Проверьте интересующее состояние на работоспособность:

```shell
su -
echo pstate > /sys/kernel/debug/dri/0/pstate
```

Если всё работает стабильно и нет проблем, можно записать пресет в параметры ядра. Обратите внимание, что в выводе у нас было значение в шестнадцатеричном формате, для добавления в параметры ядра, значение необходимо перевести в десятеричный формат (для этого можно использовать любой конвертер из десятичной системы счисления в шестнадцатеричную).

В примере будет указано значение 0f, которое перевели в десятеричный формат (15)

| Параметр                        | Описание                                                                                            |
| ------------------------------- | --------------------------------------------------------------------------------------------------- |
| `nouveau.config=NvClkMode=15`   | На этапе загрузки устанавливает необходимое состояние питания.                                      |
| `nouveau.config=NvClkModeAC=15` | На этапе загрузки устанавливает необходимое состояние питания, если устройство работает от сети.    |
| `nouveau.config=NvClkModeDC=15` | На этапе загрузки устанавливает необходимое состояние питания, если устройство работает от батареи. |

Необходимо прописать в параметр `GRUB_CMDLINE_LINUX_DEFAULT` один или несколько значений и сгенерировать новых `grub.cfg`:

```shell
su -
mcedit /etc/sysconfig/grub2
grub-mkconfig -o /boot/grub/grub.cfg
```

::: danger
Хоть эта поддержка и существует давно, она имеет статус `MOSTLY` (всё основное сделано, но имеется ряд нерешённых проблем) и, скорее всего, останется таким навсегда.

Некоторые состояния могут перегреть устройство и навредить. Делая это, пожалуйста, следите за состоянием видеочипа.
:::

### Управление скоростью вентиляторов (от Rankine до Maxwell)

Видеочипы от Rankine до Maxwell имеют поддержку управления вентиляторами.

Чтобы узнать точно, есть ли поддержка, нужно проверить, есть ли файлы управления:

```shell
ls /sys/class/drm/card0/device | grep pwm1
```

::: details Ожидаемый вид вывода

```shell
pwm1
pwm1_enable
pwm1_max
pwm1_min
```

:::

| Файл управления | Описание                                                                                    |
| --------------- | ------------------------------------------------------------------------------------------- |
| `pwm1`          | Управление постоянной скоростью.                                                            |
| `pwm1_enable`   | Включение режимов управления скоростью: `0` (выключить), `1` (вручную), `2` (автоматически) |
| `pwm1_max`      | Установка максимальной скорости.                                                            |
| `pwm1_min`      | Установка минимальной скорости.                                                             |

Путём добавления процентных значений скоростей в эти файлы (кроме `pwm1_enable`, где выбираются режимы), ими можно управлять

::: details Пример

- Включение ручного управление (если будет `0` или `2`, указывать скорости нет необходимости)

```shell
su -
echo 1 > /sys/class/drm/card0/device/pwm1_enable
```

- Установка мощности вентилятора на 40%

```shell
su -
echo 40 > /sys/class/drm/card0/device/pwm1
```

:::

Один из вариантов управления — сделать изменения постоянными. Для этого нужно занести их в `udev` правила.

- Пример ручного управления:

```shell
su -
cat << _EOF_ > /etc/udev/rules.d/50-nouveau-hwmon.rules
ACTION=="add", SUBSYSTEM=="hwmon", DRIVERS=="nouveau", ATTR{pwm1_enable}="1", ATTR{pwm1_enable}="40"
_EOF_
```

- Пример автоматического управления:

```shell
su -
cat << _EOF_ > /etc/udev/rules.d/50-nouveau-hwmon.rules
ACTION=="add", SUBSYSTEM=="hwmon", DRIVERS=="nouveau", ATTR{pwm1_enable}="2"
_EOF_
```

- Пример управления минимальными и максимальными значениями:

```shell
su -
cat << _EOF_ > /etc/udev/rules.d/50-nouveau-hwmon.rules
ACTION=="add", SUBSYSTEM=="hwmon", DRIVERS=="nouveau", ATTR{pwm1_enable}="1", ATTR{pwm1_min}="10", ATTR{pwm1_min}="90"
_EOF_
```

::: danger
При неправильном использовании есть шанс перегреть видеокарту. Соблюдайте осторожность
:::

### Список параметров Nouveau для ядра

Существует список параметров для ядра, про которые мало что можно написать или просто мало информации.

| Файл управления           | Описание                                                                                                                                                                                                                                          |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `runpm`                   | Принудительное включение (`1`) или отключение (`0`), управление питанием во время работы. По умолчанию только для систем Optimus установлено значение -`1`                                                                                        |
| `noaccel`                 | Отключение ускорение ядра / `abi16` (`1` — отключить ускорения, `0` — включить)                                                                                                                                                                   |
| `nofbaccel`               | Отключение ускорения `fbcon` (`1` — отключить ускорение, `0` — включить)                                                                                                                                                                          |
| `modeset`                 | Должен ли быть включён драйвер. `0` для отключённого, `1` для включённого, `2` для "безголового?"                                                                                                                                                 |
| `config.NvAGP`            | Режим `agp` (`0` для отключения, `1` для включения                                                                                                                                                                                                |
| `config.NvBios`           | Указать источник `VBIOS`, как один из OpenFirmware / PRAMIN / PROM / ACPI / PCIROM / PLATFORM или имя файла, переданное в `request_firmware`                                                                                                      |
| `config.NvBoost`          | Указать режим `Boost` для Fermi и новее. (`0` — базовые тактовые частоты (по умолчанию), `1` — тактовые частоты в режиме `Boost`, `2` — максимальные тактовые частоты)                                                                            |
| `config.NvFanPWM`         | Включить использование ШИМ для вентилятора, автоматическое определение по умолчанию                                                                                                                                                               |
| `config.NvForcePost`      | Нужно ли принудительно выполнять POST устройства, по умолчанию отключено                                                                                                                                                                          |
| `config.NvMemExec`        | Принудительное включение/отключение выполнения сценария синхронизации памяти.                                                                                                                                                                     |
| `config.NvGrUseFW`        | Использовать прерывания MSI, включённые по умолчанию на чипсетах, которые их поддерживают                                                                                                                                                         |
| `config.NvMXMDCB`         | Очистка выходов DCB из BIOS, включено по умолчанию                                                                                                                                                                                                |
| `config.NvPCIE`           | Только семейство NV40, использовать ли PCI-E GART, включено по умолчанию.                                                                                                                                                                         |
| `config.NvPmEnableGating` | Включает синхронизацию для графических процессоров Kepler                                                                                                                                                                                         |
| `vram_pushbuf`            | Создать push-буферы DMA во VRAM                                                                                                                                                                                                                   |
| `duallink`                | Разрешить двухканальную TMDS (включено по умолчанию)                                                                                                                                                                                              |
| `tv_norm`                 | Дефолтный ТВ норм. По умолчанию — PAL. Допустимые значения: `PAL`, `PAL-M`, `PAL-N`, `PAL-Nc`, `NTSC-M`, `NTSC-J`, `hd480i`, `hd480p`, `hd576i`, `hd576p`, `hd720p`, `hd1080i`. Это применимо только к картам, у которых нет внешних кодировщиков |
| `tv_disable`              | Отключить обнаружение ТВ-выхода                                                                                                                                                                                                                   |

### Источники:

https://nouveau.freedesktop.org/

https://wiki.archlinux.org/title/Nouveau

https://wiki.gentoo.org/wiki/Nouveau

https://web.archive.org/web/20141031191559/https://kalgan.cc/blog/posts/Controlling_nVidia_cards_fans_with_nouveau_in_Debian/
